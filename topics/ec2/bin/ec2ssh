#!/usr/bin/env sh
set -e

if [ ! type aws >/dev/null 2>&1 ]; then
    die "AWS CLI is required, but it is not installed."
fi

region="us-east-1"
jump=""
host=""

while test $# != 0; do
    case "$1" in
        -r) region=$2 ;;
        -j) jump=$2 ;;
        *)  host=$1
    esac
    shift
done

function die {
    echo >&2 $1
    exit 1
}

if [ -z "${host// }" ]; then
    die "Must provide region and host at minimum."
fi

cmd='ssh'

function ec2_attr {
    val=`aws ec2 describe-instances --region=${region} --query "Reservations[0].Instances[0].${2}" --filter "Name=tag:Name,Values=${1}"`
    if [ -z "${val// }" ]; then
       die "Failed to find instance named ${1} in ${region}"
    fi
    echo $val
}

if [ -z "${jump// }" ]; then
    public_ip=`ec2_attr "${host}" "PublicIpAddress"`
    cmd="${cmd} ${public_ip//\"}"
else
    public_ip=`ec2_attr "${jump}" "PublicIpAddress"`
    private_ip=`ec2_attr "${host}" "PrivateIpAddress"`
    cmd="${cmd} -A -t ${public_ip//\"} ssh -A ${private_ip//\"}"
fi

echo "executing: ${cmd}"
${cmd}
