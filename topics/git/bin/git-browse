#!/usr/bin/env bash
error() {
    local src=$1
    local ln=$2
    echo "Error at ${src}:${ln}"
    sed "${ln}!d" ${src}
    exit 1
}
#trap 'error "${BASH_SOURCE}" "${LINENO}"' ERR

function die() {
    echo $1
    exit 1
}

function launch() {
    echo "Opening ${1}"
    git web--browse ${1}
}

REF=${1:-\@\{u\}}
REMOTE_NAME=$(git rev-parse --abbrev-ref --symbolic-full-name ${REF} | sed 's/^remotes\///')
REMOTE=$(echo ${REMOTE_NAME} | cut -d'/' -f1)
REMOTE_BRANCH=$(echo ${REMOTE_NAME} | cut -d'/' -f2-)
REMOTE_URL=$(git config --get remote.${REMOTE}.url)
REMOTE_ID=$(echo ${REMOTE_URL} | cut -d':' -f2 | sed 's/\.git$//')

case $REMOTE_URL in
    *@github.com\/*)
        REMOTE_ID=$(git config --get remote.origin.url | cut -d'/' -f4- | cut -d'.' -f1)
        launch "https://github.com/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    https:\/\/github.com\/*)
        REMOTE_ID=$(git config --get remote.origin.url | cut -d'/' -f4- | cut -d'.' -f1)
        launch "https://github.com/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    *@github.com:*)
        launch "https://github.com/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    *@bitbucket.org:*)
        launch "https://bitbucket.org/${REMOTE_ID}/src?at=${REMOTE_BRANCH}" ;;
    git@git.sr.ht:*)
        launch "https://git.sr.ht/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    *) die "Unsupported remote: ${REMOTE_URL}" ;;
esac
