#!/usr/bin/env bash
set -e

OPEN_CMD='open'
UNAME=$(uname | tr "[:upper:]" "[:lower:]")
if [ "$UNAME" == "linux" ]; then
    OPEN_CMD='xdg-open'
fi

function die() {
    echo $1
    exit 1
}

REMOTE_NAME=$(git rev-parse --abbrev-ref --symbolic-full-name @{u})
REMOTE=$(echo ${REMOTE_NAME} | cut -d'/' -f1)
REMOTE_BRANCH=$(echo ${REMOTE_NAME} | cut -d'/' -f2-)
REMOTE_URL=$(git config --get remote.${REMOTE}.url)
REMOTE_ID=$(echo ${REMOTE_URL} | cut -d':' -f2 | cut -d'.' -f1)

case $REMOTE_URL in
    *@github.com\/*)
        REMOTE_ID=$(git config --get remote.origin.url | cut -d'/' -f4- | cut -d'.' -f1)
        ${OPEN_CMD} "https://github.com/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    https:\/\/github.com\/*)
        REMOTE_ID=$(git config --get remote.origin.url | cut -d'/' -f4- | cut -d'.' -f1)
        ${OPEN_CMD} "https://github.com/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    *@github.com:*)
        ${OPEN_CMD} "https://github.com/${REMOTE_ID}/tree/${REMOTE_BRANCH}" ;;
    *@bitbucket.org:*)
        ${OPEN_CMD} "https://bitbucket.org/${REMOTE_ID}/src?at=${REMOTE_BRANCH}" ;;
    *) die "Unsupported remote: ${REMOTE_URL}" ;;
esac
